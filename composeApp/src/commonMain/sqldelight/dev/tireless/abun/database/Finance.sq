-- Accounts Table (Chart of Accounts)
-- Hierarchy-based: 5 root accounts with FIXED IDs
-- All other accounts are descendants of these 5 roots
-- Account type is determined by traversing parent_id to the root
-- Initial balance is recorded as equity transaction, current balance calculated on-demand
-- IMPORTANT: All amounts are stored as INTEGER (actual value * 10000) to avoid floating point precision loss
CREATE TABLE Account (
    id INTEGER PRIMARY KEY NOT NULL,
    name TEXT NOT NULL,
    parent_id INTEGER, -- NULL for root accounts, or FK to parent account
    currency TEXT NOT NULL DEFAULT 'CNY',
    config INTEGER NOT NULL DEFAULT 3, -- Bitwise: bit0=active, bit1=countable, bit2=visible
    icon_name TEXT,
    color_hex TEXT,
    bill_date INTEGER CHECK (bill_date IS NULL OR (bill_date >= 1 AND bill_date <= 28)), -- Day of month 1-28 (compatible with Feb)
    payment_date INTEGER CHECK (payment_date IS NULL OR (payment_date >= 1 AND payment_date <= 28)), -- Day of month 1-28
    credit_limit INTEGER NOT NULL DEFAULT -1, -- Credit limit * 10000, -1 for non-liability accounts
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (parent_id) REFERENCES Account(id) ON DELETE SET NULL
);

-- Initialize 5 fundamental accounts with fixed IDs (must match RootAccountIds constants)
-- config = 3 means: bit0=1 (active), bit1=1 (countable), bit2=0 (invisible to UI)
INSERT INTO Account (id, name, parent_id, currency, config, created_at, updated_at)
VALUES
  (1, 'Asset', NULL, 'CNY', 3, 0, 0),      -- RootAccountIds.ASSET
  (2, 'Liability', NULL, 'CNY', 3, 0, 0),  -- RootAccountIds.LIABILITY
  (3, 'Equity', NULL, 'CNY', 3, 0, 0),     -- RootAccountIds.EQUITY
  (4, 'Revenue', NULL, 'CNY', 3, 0, 0),    -- RootAccountIds.REVENUE
  (5, 'Expense', NULL, 'CNY', 3, 0, 0);    -- RootAccountIds.EXPENSE

-- Transaction Groups Table (for grouping related transactions like loans)
CREATE TABLE TransactionGroup (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL,
    group_type TEXT NOT NULL, -- 'loan', 'installment', 'split', 'custom'
    description TEXT,
    total_amount INTEGER, -- Amount * 10000
    status TEXT NOT NULL DEFAULT 'active', -- 'active', 'completed', 'cancelled'
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
);

-- Transactions Table (Pure Double-Entry Booking)
-- IMPORTANT: All amounts are stored as INTEGER (actual value * 10000) to avoid floating point precision loss
CREATE TABLE `Transaction` (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    amount INTEGER NOT NULL, -- Always positive, actual amount * 10000 (supports up to .4f precision)
    debit_account_id INTEGER NOT NULL, -- Account being debited
    credit_account_id INTEGER NOT NULL, -- Account being credited
    transaction_date INTEGER NOT NULL, -- Timestamp in milliseconds
    transfer_group_id TEXT, -- UUID to link transfer pairs (for UI grouping)
    payee TEXT, -- Merchant/Source name
    member TEXT, -- Who this expense is for
    notes TEXT,
    state TEXT NOT NULL DEFAULT 'confirmed', -- 'planned', 'estimated', 'confirmed'
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (debit_account_id) REFERENCES Account(id) ON DELETE CASCADE,
    FOREIGN KEY (credit_account_id) REFERENCES Account(id) ON DELETE CASCADE
);

-- Transaction Group Membership (Many-to-Many)
CREATE TABLE TransactionGroupMember (
    transaction_id INTEGER NOT NULL,
    group_id INTEGER NOT NULL,
    PRIMARY KEY (transaction_id, group_id),
    FOREIGN KEY (transaction_id) REFERENCES `Transaction`(id) ON DELETE CASCADE,
    FOREIGN KEY (group_id) REFERENCES TransactionGroup(id) ON DELETE CASCADE
);

-- Tags Table
CREATE TABLE FinanceTag (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    name TEXT NOT NULL UNIQUE,
    color_hex TEXT,
    created_at INTEGER NOT NULL
);

-- Transaction-Tag Association Table (Many-to-Many)
CREATE TABLE TransactionTag (
    transaction_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    PRIMARY KEY (transaction_id, tag_id),
    FOREIGN KEY (transaction_id) REFERENCES `Transaction`(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES FinanceTag(id) ON DELETE CASCADE
);

-- Attachments Table
CREATE TABLE TransactionAttachment (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    transaction_id INTEGER NOT NULL,
    file_path TEXT NOT NULL,
    file_type TEXT NOT NULL, -- 'image', 'pdf', etc.
    created_at INTEGER NOT NULL,
    FOREIGN KEY (transaction_id) REFERENCES `Transaction`(id) ON DELETE CASCADE
);

-- Linked Items Table (Cross-module linking)
CREATE TABLE TransactionLinkedItem (
    id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    transaction_id INTEGER NOT NULL,
    linked_item_id INTEGER NOT NULL,
    linked_item_type TEXT NOT NULL, -- 'note', 'task', 'timeblock', 'event', etc.
    created_at INTEGER NOT NULL,
    FOREIGN KEY (transaction_id) REFERENCES `Transaction`(id) ON DELETE CASCADE
);

-- Note: Transaction Templates and Recurring Transactions removed temporarily
-- Will be re-implemented after full migration to debit/credit model

-- Queries for Accounts
insertAccount:
INSERT INTO Account (name, parent_id, currency, config, icon_name, color_hex, bill_date, payment_date, credit_limit, created_at, updated_at)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

updateAccount:
UPDATE Account
SET name = ?, parent_id = ?, currency = ?, config = ?, icon_name = ?, color_hex = ?, bill_date = ?, payment_date = ?, credit_limit = ?, updated_at = ?
WHERE id = ?;

deleteAccount:
DELETE FROM Account WHERE id = ? AND id > 5;  -- Prevent deletion of root accounts

getAccountById:
SELECT * FROM Account WHERE id = ?;

getAllAccounts:
SELECT * FROM Account ORDER BY (config & 1) DESC, created_at DESC;  -- bit0 = active

getActiveAccounts:
SELECT * FROM Account WHERE (config & 1) = 1 ORDER BY created_at DESC;  -- bit0 = active

-- Get all expense categories (sub-accounts of Expense root, id=5)
getExpenseCategories:
SELECT * FROM Account WHERE parent_id = 5 AND (config & 1) = 1 ORDER BY name;

-- Get all revenue categories (sub-accounts of Revenue root, id=4)
getRevenueCategories:
SELECT * FROM Account WHERE parent_id = 4 AND (config & 1) = 1 ORDER BY name;

-- Get all asset accounts (sub-accounts of Asset root, id=1)
getAssetAccounts:
SELECT * FROM Account WHERE parent_id = 1 AND (config & 1) = 1 ORDER BY name;

-- Get all liability accounts (sub-accounts of Liability root, id=2)
getLiabilityAccounts:
SELECT * FROM Account WHERE parent_id = 2 AND (config & 1) = 1 ORDER BY name;

-- Queries for Transaction Groups
insertTransactionGroup:
INSERT INTO TransactionGroup (name, group_type, description, total_amount, status, created_at, updated_at)
VALUES (?, ?, ?, ?, ?, ?, ?);

updateTransactionGroup:
UPDATE TransactionGroup
SET name = ?, description = ?, status = ?, updated_at = ?
WHERE id = ?;

deleteTransactionGroup:
DELETE FROM TransactionGroup WHERE id = ?;

getTransactionGroupById:
SELECT * FROM TransactionGroup WHERE id = ?;

getAllTransactionGroups:
SELECT * FROM TransactionGroup ORDER BY created_at DESC;

getTransactionGroupsByType:
SELECT * FROM TransactionGroup WHERE group_type = ? ORDER BY created_at DESC;

-- Queries for Transaction Group Membership
addTransactionToGroup:
INSERT OR IGNORE INTO TransactionGroupMember (transaction_id, group_id) VALUES (?, ?);

removeTransactionFromGroup:
DELETE FROM TransactionGroupMember WHERE transaction_id = ? AND group_id = ?;

getGroupsForTransaction:
SELECT g.* FROM TransactionGroup g
INNER JOIN TransactionGroupMember m ON g.id = m.group_id
WHERE m.transaction_id = ?
ORDER BY g.created_at;

getTransactionsByGroup:
SELECT t.* FROM `Transaction` t
INNER JOIN TransactionGroupMember m ON t.id = m.transaction_id
WHERE m.group_id = ?
ORDER BY t.transaction_date;

-- Queries for Transactions
insertTransaction:
INSERT INTO `Transaction` (amount, debit_account_id, credit_account_id, transaction_date, transfer_group_id, payee, member, notes, state, created_at, updated_at)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

updateTransaction:
UPDATE `Transaction`
SET amount = ?, debit_account_id = ?, credit_account_id = ?, transaction_date = ?, transfer_group_id = ?, payee = ?, member = ?, notes = ?, state = ?, updated_at = ?
WHERE id = ?;

deleteTransaction:
DELETE FROM `Transaction` WHERE id = ?;

getTransactionById:
SELECT * FROM `Transaction` WHERE id = ?;

getAllTransactions:
SELECT * FROM `Transaction` ORDER BY transaction_date DESC, created_at DESC;

getTransactionsByAccount:
SELECT * FROM `Transaction`
WHERE debit_account_id = ? OR credit_account_id = ?
ORDER BY transaction_date DESC;

getTransactionsByDateRange:
SELECT * FROM `Transaction`
WHERE transaction_date BETWEEN ? AND ?
ORDER BY transaction_date DESC;

-- Removed: getTransactionsByType (no longer has type column)

getTransferPair:
SELECT * FROM `Transaction` WHERE transfer_group_id = ? ORDER BY created_at;

getPlannedTransactions:
SELECT * FROM `Transaction` WHERE state = 'planned' ORDER BY transaction_date;

getEstimatedTransactions:
SELECT * FROM `Transaction` WHERE state = 'estimated' ORDER BY transaction_date;

getTransactionsByState:
SELECT * FROM `Transaction` WHERE state = ? ORDER BY transaction_date;

updateTransactionState:
UPDATE `Transaction` SET state = ?, updated_at = ? WHERE id = ?;

-- Queries for Tags
insertFinanceTag:
INSERT INTO FinanceTag (name, color_hex, created_at)
VALUES (?, ?, ?);

updateFinanceTag:
UPDATE FinanceTag SET name = ?, color_hex = ? WHERE id = ?;

deleteFinanceTag:
DELETE FROM FinanceTag WHERE id = ?;

getFinanceTagById:
SELECT * FROM FinanceTag WHERE id = ?;

getAllFinanceTags:
SELECT * FROM FinanceTag ORDER BY name;

getFinanceTagByName:
SELECT * FROM FinanceTag WHERE name = ?;

-- Queries for Transaction-Tag associations
addTagToTransaction:
INSERT OR IGNORE INTO TransactionTag (transaction_id, tag_id) VALUES (?, ?);

removeTagFromTransaction:
DELETE FROM TransactionTag WHERE transaction_id = ? AND tag_id = ?;

getTagsForTransaction:
SELECT t.* FROM FinanceTag t
INNER JOIN TransactionTag tt ON t.id = tt.tag_id
WHERE tt.transaction_id = ?
ORDER BY t.name;

getTransactionsByTag:
SELECT ft.* FROM `Transaction` ft
INNER JOIN TransactionTag tt ON ft.id = tt.transaction_id
WHERE tt.tag_id = ?
ORDER BY ft.transaction_date DESC;

-- Queries for Attachments
insertAttachment:
INSERT INTO TransactionAttachment (transaction_id, file_path, file_type, created_at)
VALUES (?, ?, ?, ?);

deleteAttachment:
DELETE FROM TransactionAttachment WHERE id = ?;

getAttachmentsForTransaction:
SELECT * FROM TransactionAttachment WHERE transaction_id = ? ORDER BY created_at;

-- Queries for Linked Items
insertLinkedItem:
INSERT INTO TransactionLinkedItem (transaction_id, linked_item_id, linked_item_type, created_at)
VALUES (?, ?, ?, ?);

deleteLinkedItem:
DELETE FROM TransactionLinkedItem WHERE id = ?;

getLinkedItemsForTransaction:
SELECT * FROM TransactionLinkedItem WHERE transaction_id = ? ORDER BY created_at;

getTransactionsByLinkedItem:
SELECT ft.* FROM `Transaction` ft
INNER JOIN TransactionLinkedItem tli ON ft.id = tli.transaction_id
WHERE tli.linked_item_id = ? AND tli.linked_item_type = ?
ORDER BY ft.transaction_date DESC;

-- Note: Template and recurring transaction queries removed
-- Will be re-implemented after full migration to debit/credit model

-- Analytics Queries
-- Calculate account balance by summing all transaction debits minus credits
-- Returns INTEGER (amount * 10000)
calculateAccountBalance:
SELECT
  COALESCE(
    (SELECT SUM(amount) FROM `Transaction` WHERE debit_account_id = ?) -
    (SELECT SUM(amount) FROM `Transaction` WHERE credit_account_id = ?),
    0
  ) AS balance;

getRecentPayees:
SELECT DISTINCT payee FROM `Transaction`
WHERE payee IS NOT NULL AND payee != ''
ORDER BY transaction_date DESC
LIMIT 20;
